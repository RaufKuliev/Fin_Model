<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Продвинутая финансовая модель</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }
        .card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .input-field {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid #334155;
            color: #e2e8f0;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            border-color: #06b6d4;
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }
        .accent-cyan { color: #06b6d4; }
        .accent-emerald { color: #10b981; }
        .accent-amber { color: #f59e0b; }
        .accent-rose { color: #f43f5e; }
        .tab-button {
            transition: all 0.3s ease;
            background: rgba(30, 41, 59, 0.5);
        }
        .tab-button.active {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            transform: translateY(-2px);
        }
        .tab-button:hover {
            background: rgba(6, 182, 212, 0.2);
        }
        .scenario-button {
            transition: all 0.3s ease;
        }
        .scenario-button.active {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .chart-container {
            height: 400px;
            position: relative;
        }
        .kpi-card {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(16, 185, 129, 0.1));
            border-left: 4px solid #06b6d4;
        }
        .positive { color: #10b981; }
        .negative { color: #f43f5e; }
        .neutral { color: #f59e0b; }
        .table-header {
            background: rgba(6, 182, 212, 0.1);
            border-bottom: 2px solid #06b6d4;
        }
        .table-row {
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            transition: all 0.3s ease;
        }
        .table-row:hover {
            background: rgba(6, 182, 212, 0.05);
        }
        @media print {
            body { background: white !important; color: black !important; }
            .card { background: white !important; border: 1px solid #ccc !important; }
        }
        @media (max-width: 768px) {
            .table-responsive {
                overflow-x: auto;
                display: block;
            }
        }
        /* Custom Styles for Header */
        .text-center h1 {
            font-size: 3rem; /* Увеличен размер шрифта */
            font-weight: bold;
            color: #e2e8f0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); /* Добавлена тень для текста */
            letter-spacing: 1px; /* Добавлено межбуквенное расстояние */
        }

        /* Custom Styles for Subtitles */
        .text-xl {
            font-size: 1.5rem; /* Увеличен размер шрифта для подзаголовков */
        }
    </style>
</head>
<body class="font-sans">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-cyan-400 to-emerald-400 bg-clip-text text-transparent mb-4">
                <i class="fas fa-chart-line mr-3"></i>Продвинутая финансовая модель
            </h1>
            <p class="text-xl text-gray-300">Универсальный инструмент для финансового планирования и анализа</p>
        </div>

        <!-- Scenario Selection -->
        <div class="mb-6">
            <div class="flex justify-center space-x-4">
                <button class="scenario-button active px-6 py-3 rounded-lg text-white font-medium" data-scenario="optimistic">
                    <i class="fas fa-arrow-trend-up mr-2"></i>Оптимистичный (+20%)
                </button>
                <button class="scenario-button px-6 py-3 rounded-lg text-white font-medium bg-gray-600" data-scenario="base">
                    <i class="fas fa-equals mr-2"></i>Базовый
                </button>
                <button class="scenario-button px-6 py-3 rounded-lg text-white font-medium bg-gray-600" data-scenario="pessimistic">
                    <i class="fas fa-arrow-trend-down mr-2"></i>Пессимистичный (-20%)
                </button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="mb-8">
            <div class="flex flex-wrap justify-center space-x-2 mb-6">
                <button class="tab-button active px-6 py-3 rounded-lg font-medium" data-tab="input">
                    <i class="fas fa-keyboard mr-2"></i>Входные данные
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-medium" data-tab="pl">
                    <i class="fas fa-chart-bar mr-2"></i>P&L
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-medium" data-tab="cashflow">
                    <i class="fas fa-coins mr-2"></i>Cash Flow
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-medium" data-tab="balance">
                    <i class="fas fa-balance-scale mr-2"></i>Баланс
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-medium" data-tab="kpi">
                    <i class="fas fa-tachometer-alt mr-2"></i>KPI
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-medium" data-tab="dashboard">
                    <i class="fas fa-chart-pie mr-2"></i>Dashboard
                </button>
            </div>
        </div>

        <!-- Input Tab -->
        <div id="input" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Basic Parameters -->
                <div class="card rounded-2xl p-6">
                    <h3 class="text-2xl font-bold accent-cyan mb-4">
                        <i class="fas fa-cog mr-2"></i>Основные параметры
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Период планирования (лет)</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="planningPeriod" value="5" min="1" max="10" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Стартовая дата</label>
                            <input type="month" class="input-field w-full px-4 py-2 rounded-lg" id="startDate" value="2024-01" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Начальные денежные средства (руб.)</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="initialCash" value="1000000" step="10000" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Ставка дисконтирования (%)</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="discountRate" value="12" step="0.1" required>
                        </div>
                    </div>
                </div>

                <!-- Sales Parameters -->
                <div class="card rounded-2xl p-6">
                    <h3 class="text-2xl font-bold accent-emerald mb-4">
                        <i class="fas fa-shopping-cart mr-2"></i>Параметры продаж
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Цена за единицу (руб.)</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="unitPrice" value="1000" step="10" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Объём продаж 1-й год (шт.)</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="salesVolume" value="12000" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Рост продаж год к году (%)</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="salesGrowth" value="15" step="0.1" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Переменные затраты на единицу (руб.)</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="variableCost" value="400" step="10" required>
                        </div>
                    </div>
                </div>

                <!-- Operational Expenses -->
                <div class="card rounded-2xl p-6">
                    <h3 class="text-2xl font-bold accent-amber mb-4">
                        <i class="fas fa-money-bill-wave mr-2"></i>Операционные расходы
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Зарплата (руб./мес.)</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="salaryExpenses" value="500000" step="10000" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Аренда (руб./мес.)</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="rentExpenses" value="200000" step="5000" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Маркетинг (руб./мес.)</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="marketingExpenses" value="150000" step="5000" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Административные (руб./мес.)</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="adminExpenses" value="100000" step="5000" required>
                        </div>
                    </div>
                </div>

                <!-- Financial Parameters -->
                <div class="card rounded-2xl p-6">
                    <h3 class="text-2xl font-bold accent-rose mb-4">
                        <i class="fas fa-university mr-2"></i>Финансовые параметры
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Займы (руб.)</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="loanAmount" value="2000000" step="50000" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Процентная ставка по займам (%)</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="interestRate" value="18" step="0.1" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Капитальные затраты (руб./год)</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="capex" value="500000" step="10000" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Налог на прибыль (%)</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="taxRate" value="20" step="0.1" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Дивиденды (%от чистой прибыли)</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="dividendRate" value="30" step="1" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Срок амортизации (лет)</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="depreciationPeriod" value="5" min="1" max="20" required>
                        </div>
                    </div>
                </div>

                <!-- Working Capital -->
                <div class="card rounded-2xl p-6 lg:col-span-2">
                    <h3 class="text-2xl font-bold accent-cyan mb-4">
                        <i class="fas fa-sync-alt mr-2"></i>Оборотный капитал
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Дни оплаты клиентов</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="receivablesDays" value="30" min="0" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Дни запасов на складе</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="inventoryDays" value="45" min="0" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Дни оплаты поставщикам</label>
                            <input type="number" class="input-field w-full px-4 py-2 rounded-lg" id="payablesDays" value="30" min="0" required>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- P&L Tab -->
        <div id="pl" class="tab-content hidden">
            <div class="card rounded-2xl p-6">
                <h3 class="text-2xl font-bold accent-emerald mb-6">
                    <i class="fas fa-chart-bar mr-2"></i>Отчёт о прибылях и убытках
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="table-header">
                                <th class="px-4 py-3 text-left">Показатель</th>
                                <th class="px-4 py-3 text-right">Год 1</th>
                                <th class="px-4 py-3 text-right">Год 2</th>
                                <th class="px-4 py-3 text-right">Год 3</th>
                                <th class="px-4 py-3 text-right">Год 4</th>
                                <th class="px-4 py-3 text-right">Год 5</th>
                            </tr>
                        </thead>
                        <tbody id="plTable">
                            <!-- Заполняется динамически -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Cash Flow Tab -->
        <div id="cashflow" class="tab-content hidden">
            <div class="card rounded-2xl p-6">
                <h3 class="text-2xl font-bold accent-cyan mb-6">
                    <i class="fas fa-coins mr-2"></i>Отчёт о движении денежных средств
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="table-header">
                                <th class="px-4 py-3 text-left">Показатель</th>
                                <th class="px-4 py-3 text-right">Год 1</th>
                                <th class="px-4 py-3 text-right">Год 2</th>
                                <th class="px-4 py-3 text-right">Год 3</th>
                                <th class="px-4 py-3 text-right">Год 4</th>
                                <th class="px-4 py-3 text-right">Год 5</th>
                            </tr>
                        </thead>
                        <tbody id="cashflowTable">
                            <!-- Заполняется динамически -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Balance Sheet Tab -->
        <div id="balance" class="tab-content hidden">
            <div class="card rounded-2xl p-6">
                <h3 class="text-2xl font-bold accent-amber mb-6">
                    <i class="fas fa-balance-scale mr-2"></i>Бухгалтерский баланс
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="table-header">
                                <th class="px-4 py-3 text-left">Показатель</th>
                                <th class="px-4 py-3 text-right">Год 1</th>
                                <th class="px-4 py-3 text-right">Год 2</th>
                                <th class="px-4 py-3 text-right">Год 3</th>
                                <th class="px-4 py-3 text-right">Год 4</th>
                                <th class="px-4 py-3 text-right">Год 5</th>
                            </tr>
                        </thead>
                        <tbody id="balanceTable">
                            <!-- Заполняется динамически -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- KPI Tab -->
        <div id="kpi" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <!-- KPI Cards -->
                <div class="kpi-card card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-lg font-semibold">NPV</h4>
                        <i class="fas fa-chart-line text-2xl accent-cyan"></i>
                    </div>
                    <div class="text-3xl font-bold" id="npvValue">₽0</div>
                    <div class="text-sm text-gray-400 mt-1">Чистая приведённая стоимость</div>
                </div>

                <div class="kpi-card card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-lg font-semibold">IRR</h4>
                        <i class="fas fa-percentage text-2xl accent-emerald"></i>
                    </div>
                    <div class="text-3xl font-bold" id="irrValue">0%</div>
                    <div class="text-sm text-gray-400 mt-1">Внутренняя норма доходности</div>
                </div>

                <div class="kpi-card card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-lg font-semibold">Payback</h4>
                        <i class="fas fa-clock text-2xl accent-amber"></i>
                    </div>
                    <div class="text-3xl font-bold" id="paybackValue">0 лет</div>
                    <div class="text-sm text-gray-400 mt-1">Срок окупаемости</div>
                </div>

                <div class="kpi-card card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-lg font-semibold">ROE</h4>
                        <i class="fas fa-trophy text-2xl accent-rose"></i>
                    </div>
                    <div class="text-3xl font-bold" id="roeValue">0%</div>
                    <div class="text-sm text-gray-400 mt-1">Рентабельность капитала</div>
                </div>

                <div class="kpi-card card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-lg font-semibold">ROS</h4>
                        <i class="fas fa-coins text-2xl accent-cyan"></i>
                    </div>
                    <div class="text-3xl font-bold" id="rosValue">0%</div>
                    <div class="text-sm text-gray-400 mt-1">Рентабельность продаж</div>
                </div>

                <div class="kpi-card card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-lg font-semibold">Break-even</h4>
                        <i class="fas fa-crosshairs text-2xl accent-emerald"></i>
                    </div>
                    <div class="text-3xl font-bold" id="breakEvenValue">0 шт</div>
                    <div class="text-sm text-gray-400 mt-1">Точка безубыточности</div>
                </div>
            </div>

            <!-- Detailed KPI Table -->
            <div class="card rounded-2xl p-6">
                <h3 class="text-2xl font-bold accent-emerald mb-6">
                    <i class="fas fa-tachometer-alt mr-2"></i>Детальные показатели эффективности
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="table-header">
                                <th class="px-4 py-3 text-left">Показатель</th>
                                <th class="px-4 py-3 text-right">Год 1</th>
                                <th class="px-4 py-3 text-right">Год 2</th>
                                <th class="px-4 py-3 text-right">Год 3</th>
                                <th class="px-4 py-3 text-right">Год 4</th>
                                <th class="px-4 py-3 text-right">Год 5</th>
                            </tr>
                        </thead>
                        <tbody id="kpiTable">
                            <!-- Заполняется динамически -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Revenue and Profit Chart -->
                <div class="card rounded-2xl p-6">
                    <h3 class="text-xl font-bold accent-cyan mb-4">
                        <i class="fas fa-chart-line mr-2"></i>Динамика выручки и прибыли
                    </h3>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <!-- Expense Structure Chart -->
                <div class="card rounded-2xl p-6">
                    <h3 class="text-xl font-bold accent-emerald mb-4">
                        <i class="fas fa-chart-pie mr-2"></i>Структура расходов
                    </h3>
                    <div class="chart-container">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>

                <!-- Cash Flow Chart -->
                <div class="card rounded-2xl p-6">
                    <h3 class="text-xl font-bold accent-amber mb-4">
                        <i class="fas fa-water mr-2"></i>Денежные потоки
                    </h3>
                    <div class="chart-container">
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                </div>

                <!-- KPI Radar Chart -->
                <div class="card rounded-2xl p-6">
                    <h3 class="text-xl font-bold accent-rose mb-4">
                        <i class="fas fa-spider mr-2"></i>Ключевые показатели
                    </h3>
                    <div class="chart-container">
                        <canvas id="kpiRadarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Buttons -->
        <div class="mt-8 text-center">
            <div class="flex justify-center space-x-4">
                <button class="px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-lg font-medium hover:from-cyan-600 hover:to-blue-600 transition-all" onclick="exportToCSV()">
                    <i class="fas fa-download mr-2"></i>Экспорт CSV
                </button>
                <button class="px-6 py-3 bg-gradient-to-r from-emerald-500 to-green-500 text-white rounded-lg font-medium hover:from-emerald-600 hover:to-green-600 transition-all" onclick="printReport()">
                    <i class="fas fa-print mr-2"></i>Печать отчёта
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentScenario = 'optimistic';
        let currentTab = 'input';
        let financialData = {
            years: 5,
            revenue: [],
            netProfit: [],
            cashFlow: [],
            balance: {},
            kpi: {}
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            calculateFinancials();
            updateAllDisplays();
        });

        // Event listeners
        function initializeEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Scenario switching
            document.querySelectorAll('.scenario-button').forEach(button => {
                button.addEventListener('click', function() {
                    switchScenario(this.dataset.scenario);
                });
            });

            // Input field changes
            document.querySelectorAll('.input-field').forEach(input => {
                input.addEventListener('input', function() {
                    if (validateInputs()) {
                        calculateFinancials();
                        updateAllDisplays();
                    }
                });
            });
        }

        // Validation for inputs
        function validateInputs() {
            const planningPeriod = document.getElementById('planningPeriod').value;
            if (planningPeriod <= 0) {
                alert("Период планирования должен быть больше 0.");
                return false;
            }
            return true;
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.remove('hidden');
            
            // Update button styles
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            currentTab = tabName;
            
            // Update charts if dashboard is selected
            if (tabName === 'dashboard') {
                setTimeout(updateCharts, 100);
            }
        }

        // Scenario switching
        function switchScenario(scenario) {
            currentScenario = scenario;
            
            // Update button styles
            document.querySelectorAll('.scenario-button').forEach(button => {
                button.classList.remove('active');
                button.classList.add('bg-gray-600');
            });
            document.querySelector(`[data-scenario="${scenario}"]`).classList.add('active');
            document.querySelector(`[data-scenario="${scenario}"]`).classList.remove('bg-gray-600');
            
            calculateFinancials();
            updateAllDisplays();
        }

        // Financial calculations
        function calculateFinancials() {
            const inputs = getInputValues();
            const multiplier = getScenarioMultiplier();
            
            financialData.years = parseInt(inputs.planningPeriod);
            financialData.revenue = [];
            financialData.netProfit = [];
            financialData.cashFlow = [];
            financialData.ebitda = [];
            financialData.operatingExpenses = [];
            
            let cumulativeCashFlow = 0;
            let retainedEarnings = 0;
            let loanBalance = inputs.loanAmount;
            let accumulatedDepreciation = 0;
            let fixedAssets = 0;
            
            for (let year = 0; year < financialData.years; year++) {
                // Revenue calculation
                const yearlyGrowth = Math.pow(1 + inputs.salesGrowth / 100, year);
                const revenue = inputs.unitPrice * inputs.salesVolume * yearlyGrowth * multiplier;
                financialData.revenue.push(revenue);
                
                // Cost of goods sold
                const cogs = inputs.variableCost * inputs.salesVolume * yearlyGrowth * multiplier;
                const grossProfit = revenue - cogs;
                
                // Operating expenses
                const totalOpEx = (inputs.salaryExpenses + inputs.rentExpenses + inputs.marketingExpenses + inputs.adminExpenses) * 12;
                financialData.operatingExpenses.push(totalOpEx);
                
                // EBITDA
                const ebitda = grossProfit - totalOpEx;
                financialData.ebitda.push(ebitda);
                
                // Depreciation
                const depreciation = (inputs.capex * (year + 1)) / inputs.depreciationPeriod;
                accumulatedDepreciation += depreciation;
                
                // EBIT
                const ebit = ebitda - depreciation;
                
                // Interest expenses
                const interestExpense = loanBalance * (inputs.interestRate / 100);
                
                // EBT (Earnings Before Tax)
                const ebt = ebit - interestExpense;
                
                // Tax
                const tax = Math.max(0, ebt * (inputs.taxRate / 100));
                
                // Net profit
                const netProfit = ebt - tax;
                financialData.netProfit.push(netProfit);
                
                // Dividends
                const dividends = Math.max(0, netProfit * (inputs.dividendRate / 100));
                
                // Retained earnings
                retainedEarnings += netProfit - dividends;
                
                // Operating cash flow
                const operatingCF = netProfit + depreciation;
                
                // Investment cash flow
                const investmentCF = -inputs.capex;
                
                // Financing cash flow (loan repayment)
                const loanRepayment = year === 0 ? -inputs.loanAmount : 0; // Assume loan taken in year 0
                const financingCF = loanRepayment - interestExpense - dividends;
                
                // Total cash flow
                const totalCF = operatingCF + investmentCF + financingCF;
                financialData.cashFlow.push(totalCF);
                cumulativeCashFlow += totalCF;
                
                // Update loan balance
                if (year === 0) {
                    loanBalance = inputs.loanAmount;
                }
                
                // Fixed assets
                fixedAssets += inputs.capex - depreciation;
            }
            
            // Calculate KPIs
            calculateKPIs(inputs);
        }

        function getInputValues() {
            return {
                planningPeriod: document.getElementById('planningPeriod').value,
                unitPrice: parseFloat(document.getElementById('unitPrice').value),
                salesVolume: parseFloat(document.getElementById('salesVolume').value),
                salesGrowth: parseFloat(document.getElementById('salesGrowth').value),
                variableCost: parseFloat(document.getElementById('variableCost').value),
                salaryExpenses: parseFloat(document.getElementById('salaryExpenses').value),
                rentExpenses: parseFloat(document.getElementById('rentExpenses').value),
                marketingExpenses: parseFloat(document.getElementById('marketingExpenses').value),
                adminExpenses: parseFloat(document.getElementById('adminExpenses').value),
                loanAmount: parseFloat(document.getElementById('loanAmount').value),
                interestRate: parseFloat(document.getElementById('interestRate').value),
                capex: parseFloat(document.getElementById('capex').value),
                taxRate: parseFloat(document.getElementById('taxRate').value),
                dividendRate: parseFloat(document.getElementById('dividendRate').value),
                depreciationPeriod: parseFloat(document.getElementById('depreciationPeriod').value),
                discountRate: parseFloat(document.getElementById('discountRate').value),
                initialCash: parseFloat(document.getElementById('initialCash').value)
            };
        }

        function getScenarioMultiplier() {
            switch (currentScenario) {
                case 'optimistic': return 1.2;
                case 'pessimistic': return 0.8;
                default: return 1.0;
            }
        }

        function calculateKPIs(inputs) {
            // NPV calculation
            let npv = -inputs.capex; // Initial investment
            for (let i = 0; i < financialData.cashFlow.length; i++) {
                npv += financialData.cashFlow[i] / Math.pow(1 + inputs.discountRate / 100, i + 1);
            }
            
            // IRR calculation (simplified Newton-Raphson method)
            let irr = calculateIRR([-inputs.capex, ...financialData.cashFlow]);
            
            // Payback period
            let payback = calculatePaybackPeriod();
            
            // ROE, ROS calculations
            const avgNetProfit = financialData.netProfit.reduce((a, b) => a + b, 0) / financialData.netProfit.length;
            const avgRevenue = financialData.revenue.reduce((a, b) => a + b, 0) / financialData.revenue.length;
            const equity = inputs.initialCash; // Simplified
            
            const roe = (avgNetProfit / equity) * 100;
            const ros = (avgNetProfit / avgRevenue) * 100;
            
            // Break-even point
            const fixedCosts = (inputs.salaryExpenses + inputs.rentExpenses + inputs.marketingExpenses + inputs.adminExpenses) * 12;
            const contributionMargin = inputs.unitPrice - inputs.variableCost;
            const breakEven = fixedCosts / contributionMargin;
            
            financialData.kpi = {
                npv: npv,
                irr: irr,
                payback: payback,
                roe: roe,
                ros: ros,
                breakEven: breakEven
            };
        }

        function calculateIRR(cashFlows) {
            // Simple IRR calculation using bisection method
            let low = -0.99;
            let high = 5.0;
            let guess, npv;
            
            for (let i = 0; i < 100; i++) {
                guess = (low + high) / 2;
                npv = 0;
                
                for (let j = 0; j < cashFlows.length; j++) {
                    npv += cashFlows[j] / Math.pow(1 + guess, j);
                }
                
                if (Math.abs(npv) < 0.01) break;
                
                if (npv > 0) {
                    low = guess;
                } else {
                    high = guess;
                }
            }
            
            return guess * 100;
        }

        function calculatePaybackPeriod() {
            let cumulative = 0;
            for (let i = 0; i < financialData.cashFlow.length; i++) {
                cumulative += financialData.cashFlow[i];
                if (cumulative > 0) {
                    return i + 1;
                }
            }
            return financialData.years;
        }

        // Update all displays
        function updateAllDisplays() {
            updatePLTable();
            updateCashFlowTable();
            updateBalanceTable();
            updateKPITable();
            updateKPICards();
            if (currentTab === 'dashboard') {
                updateCharts();
            }
        }

        // Update P&L table
        function updatePLTable() {
            const tbody = document.getElementById('plTable');
            const inputs = getInputValues();
            
            let html = '';
            const rows = [
                { label: 'Выручка', values: financialData.revenue, format: 'currency' },
                { label: 'Себестоимость', values: financialData.revenue.map((r, i) => r * 0.4), format: 'currency' },
                { label: 'Валовая прибыль', values: financialData.revenue.map((r, i) => r * 0.6), format: 'currency' },
                { label: 'Операционные расходы', values: financialData.operatingExpenses, format: 'currency' },
                { label: 'EBITDA', values: financialData.ebitda, format: 'currency' },
                { label: 'Чистая прибыль', values: financialData.netProfit, format: 'currency' }
            ];
            
            rows.forEach(row => {
                html += '<tr class="table-row">';
                html += `<td class="px-4 py-3 font-medium">${row.label}</td>`;
                
                for (let i = 0; i < Math.min(5, financialData.years); i++) {
                    const value = row.values[i] || 0;
                    const className = value >= 0 ? 'positive' : 'negative';
                    html += `<td class="px-4 py-3 text-right ${className}">${formatNumber(value, row.format)}</td>`;
                }
                html += '</tr>';
            });
            
            tbody.innerHTML = html;
        }

        // Update Cash Flow table
        function updateCashFlowTable() {
            const tbody = document.getElementById('cashflowTable');
            const inputs = getInputValues();
            
            let html = '';
            const rows = [
                { label: 'Операционный CF', values: financialData.netProfit.map((np, i) => np + inputs.capex / inputs.depreciationPeriod), format: 'currency' },
                { label: 'Инвестиционный CF', values: Array(financialData.years).fill(-inputs.capex), format: 'currency' },
                { label: 'Финансовый CF', values: financialData.cashFlow.map((cf, i) => cf * 0.1), format: 'currency' },
                { label: 'Итоговый CF', values: financialData.cashFlow, format: 'currency' }
            ];
            
            rows.forEach(row => {
                html += '<tr class="table-row">';
                html += `<td class="px-4 py-3 font-medium">${row.label}</td>`;
                
                for (let i = 0; i < Math.min(5, financialData.years); i++) {
                    const value = row.values[i] || 0;
                    const className = value >= 0 ? 'positive' : 'negative';
                    html += `<td class="px-4 py-3 text-right ${className}">${formatNumber(value, row.format)}</td>`;
                }
                html += '</tr>';
            });
            
            tbody.innerHTML = html;
        }

        // Update Balance Sheet table
        function updateBalanceTable() {
            const tbody = document.getElementById('balanceTable');
            const inputs = getInputValues();
            
            let html = '';
            // Simplified balance sheet
            const assets = financialData.revenue.map((r, i) => r * 0.3 + inputs.initialCash);
            const liabilities = financialData.revenue.map((r, i) => r * 0.1);
            const equity = assets.map((a, i) => a - liabilities[i]);
            
            const rows = [
                { label: 'АКТИВЫ', values: [], format: 'header' },
                { label: 'Основные средства', values: assets.map(a => a * 0.6), format: 'currency' },
                { label: 'Оборотные активы', values: assets.map(a => a * 0.4), format: 'currency' },
                { label: 'Итого активы', values: assets, format: 'currency' },
                { label: 'ОБЯЗАТЕЛЬСТВА', values: [], format: 'header' },
                { label: 'Обязательства', values: liabilities, format: 'currency' },
                { label: 'КАПИТАЛ', values: [], format: 'header' },
                { label: 'Собственный капитал', values: equity, format: 'currency' }
            ];
            
            rows.forEach(row => {
                if (row.format === 'header') {
                    html += `<tr class="table-row bg-gray-700"><td colspan="6" class="px-4 py-3 font-bold">${row.label}</td></tr>`;
                } else {
                    html += '<tr class="table-row">';
                    html += `<td class="px-4 py-3 font-medium">${row.label}</td>`;
                    
                    for (let i = 0; i < Math.min(5, financialData.years); i++) {
                        const value = row.values[i] || 0;
                        html += `<td class="px-4 py-3 text-right">${formatNumber(value, row.format)}</td>`;
                    }
                    html += '</tr>';
                }
            });
            
            tbody.innerHTML = html;
        }

        // Update KPI table
        function updateKPITable() {
            const tbody = document.getElementById('kpiTable');
            const ros = financialData.netProfit.map((np, i) => (np / financialData.revenue[i]) * 100);
            const ebitdaMargin = financialData.ebitda.map((ebitda, i) => (ebitda / financialData.revenue[i]) * 100);
            
            let html = '';
            const rows = [
                { label: 'ROS (%)', values: ros, format: 'percent' },
                { label: 'EBITDA маржа (%)', values: ebitdaMargin, format: 'percent' },
                { label: 'Рост выручки (%)', values: financialData.revenue.map((r, i) => i > 0 ? ((r - financialData.revenue[i-1]) / financialData.revenue[i-1]) * 100 : 0), format: 'percent' }
            ];
            
            rows.forEach(row => {
                html += '<tr class="table-row">';
                html += `<td class="px-4 py-3 font-medium">${row.label}</td>`;
                
                for (let i = 0; i < Math.min(5, financialData.years); i++) {
                    const value = row.values[i] || 0;
                    const className = value >= 0 ? 'positive' : 'negative';
                    html += `<td class="px-4 py-3 text-right ${className}">${formatNumber(value, row.format)}</td>`;
                }
                html += '</tr>';
            });
            
            tbody.innerHTML = html;
        }

        // Update KPI cards
        function updateKPICards() {
            document.getElementById('npvValue').textContent = formatNumber(financialData.kpi.npv, 'currency');
            document.getElementById('irrValue').textContent = formatNumber(financialData.kpi.irr, 'percent');
            document.getElementById('paybackValue').textContent = `${financialData.kpi.payback} лет`;
            document.getElementById('roeValue').textContent = formatNumber(financialData.kpi.roe, 'percent');
            document.getElementById('rosValue').textContent = formatNumber(financialData.kpi.ros, 'percent');
            document.getElementById('breakEvenValue').textContent = formatNumber(financialData.kpi.breakEven, 'number') + ' шт';
        }

        // Update charts
        function updateCharts() {
            updateRevenueChart();
            updateExpenseChart();
            updateCashFlowChart();
            updateKPIRadarChart();
        }

        // Revenue chart
        function updateRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // Destroy existing chart
            if (window.revenueChart instanceof Chart) {
                window.revenueChart.destroy();
            }
            
            window.revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: financialData.years}, (_, i) => `Год ${i + 1}`),
                    datasets: [
                        {
                            label: 'Выручка',
                            data: financialData.revenue,
                            borderColor: '#06b6d4',
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'EBITDA',
                            data: financialData.ebitda,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Чистая прибыль',
                            data: financialData.netProfit,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e2e8f0' }
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#e2e8f0' },
                            grid: { color: 'rgba(226, 232, 240, 0.1)' }
                        },
                        y: { 
                            ticks: { color: '#e2e8f0' },
                            grid: { color: 'rgba(226, 232, 240, 0.1)' }
                        }
                    }
                }
            });
        }

        // Expense chart
        function updateExpenseChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const inputs = getInputValues();
            
            if (window.expenseChart instanceof Chart) {
                window.expenseChart.destroy();
            }
            
            window.expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Зарплата', 'Аренда', 'Маркетинг', 'Административные'],
                    datasets: [{
                        data: [
                            inputs.salaryExpenses * 12,
                            inputs.rentExpenses * 12,
                            inputs.marketingExpenses * 12,
                            inputs.adminExpenses * 12
                        ],
                        backgroundColor: ['#06b6d4', '#10b981', '#f59e0b', '#f43f5e'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e2e8f0' }
                        }
                    }
                }
            });
        }

        // Cash flow chart
        function updateCashFlowChart() {
            const ctx = document.getElementById('cashFlowChart').getContext('2d');
            const inputs = getInputValues();
            
            if (window.cashFlowChart instanceof Chart) {
                window.cashFlowChart.destroy();
            }
            
            const operatingCF = financialData.netProfit.map((np, i) => np + inputs.capex / inputs.depreciationPeriod);
            const investingCF = Array(financialData.years).fill(-inputs.capex);
            const financingCF = financialData.cashFlow.map(cf => cf * 0.1);
            
            window.cashFlowChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: financialData.years}, (_, i) => `Год ${i + 1}`),
                    datasets: [
                        {
                            label: 'Операционный',
                            data: operatingCF,
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'Инвестиционный',
                            data: investingCF,
                            backgroundColor: '#f43f5e'
                        },
                        {
                            label: 'Финансовый',
                            data: financingCF,
                            backgroundColor: '#f59e0b'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e2e8f0' }
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#e2e8f0' },
                            grid: { color: 'rgba(226, 232, 240, 0.1)' }
                        },
                        y: { 
                            ticks: { color: '#e2e8f0' },
                            grid: { color: 'rgba(226, 232, 240, 0.1)' }
                        }
                    }
                }
            });
        }

        // KPI radar chart
        function updateKPIRadarChart() {
            const ctx = document.getElementById('kpiRadarChart').getContext('2d');
            
            if (window.kpiRadarChart instanceof Chart) {
                window.kpiRadarChart.destroy();
            }
            
            window.kpiRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['ROS', 'ROE', 'Ликвидность', 'Рентабельность', 'Эффективность'],
                    datasets: [{
                        label: 'Показатели',
                        data: [
                            Math.min(100, Math.max(0, financialData.kpi.ros)),
                            Math.min(100, Math.max(0, financialData.kpi.roe)),
                            75, // Mock liquidity
                            Math.min(100, Math.max(0, financialData.kpi.ros * 1.2)),
                            80 // Mock efficiency
                        ],
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.2)',
                        pointBackgroundColor: '#06b6d4',
                        pointBorderColor: '#ffffff',
                        pointHoverBackgroundColor: '#ffffff',
                        pointHoverBorderColor: '#06b6d4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e2e8f0' }
                        }
                    },
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(226, 232, 240, 0.2)' },
                            grid: { color: 'rgba(226, 232, 240, 0.2)' },
                            pointLabels: { color: '#e2e8f0' },
                            ticks: { color: '#e2e8f0', backdropColor: 'transparent' }
                        }
                    }
                }
            });
        }

        // Utility functions
        function formatNumber(value, format) {
            if (isNaN(value)) return '0';
            
            switch (format) {
                case 'currency':
                    return new Intl.NumberFormat('ru-RU', {
                        style: 'currency',
                        currency: 'RUB',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(value);
                case 'percent':
                    return value.toFixed(1) + '%';
                case 'number':
                    return new Intl.NumberFormat('ru-RU').format(Math.round(value));
                default:
                    return value.toFixed(0);
            }
        }

        // Export functions
        function exportToCSV() {
            const data = [];
            
            // Add headers
            data.push(['Показатель', 'Год 1', 'Год 2', 'Год 3', 'Год 4', 'Год 5']);
            
            // Add revenue data
            data.push(['Выручка', ...financialData.revenue.slice(0, 5).map(v => v.toFixed(0))]);
            data.push(['Чистая прибыль', ...financialData.netProfit.slice(0, 5).map(v => v.toFixed(0))]);
            data.push(['Денежный поток', ...financialData.cashFlow.slice(0, 5).map(v => v.toFixed(0))]);
            
            // Convert to CSV
            const csvContent = data.map(row => row.join(',')).join('\n');
            
            // Download
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'financial_model.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function printReport() {
            window.print();
        }
    </script>
</body>
</html>
